#cloud-config

write_files:
  # TrustedCA/root-ca.pub
  - path: /etc/ssh/trusted-user-ca-keys.pem
    permissions: "0400"
    # permissions: "0640"
    content: |
      ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHzrCKSxoaZjLhxofMeYK5ko3Bs32Q2U4+258tRfJ0dK root-ca

  # TrustedHost/host_key-cert.pub
  - path: /etc/ssh/trusted-host-rsa-cert.pub
    permissions: "0400"
    # permissions: "0640"
    content: |
      ssh-ed25519-cert-v01@openssh.com AAAAIHNzaC1lZDI1NTE5LWNlcnQtdjAxQG9wZW5zc2guY29tAAAAIMqb/2XWts2AHHx2gEB1fC/pE4psGewudXanwMJaaFOoAAAAIGzGeVWueCwj5kImLlcvJHXwYIu/YwZ7zKMTBetByHhnAAAAAAAAAAAAAAACAAAAKWhvc3QtMjYyRjU4MkEtMzQ4My00QkE2LTk4NTMtQTk2NzcxNDdGNEM0AAAAIgAAAAtsb2NhbGRvbWFpbgAAAA9tdWx0aXBhc3MubG9jYWwAAAAAYcwOAAAAAABz0lBuAAAAAAAAAAAAAAAAAAAAMwAAAAtzc2gtZWQyNTUxOQAAACB86wiksaGmYy4caHzHmCuZKNwbN9kNlOPtufLUXydHSgAAAFMAAAALc3NoLWVkMjU1MTkAAABABF+XMT1Qaw37zWjGSM82s6MPf5jxf0Uzl8a5mcby6UUoiaMzECmKm730UpeN0vIQsc5DdPSGLVIcs7NQjsMpAw== root-ca

  # TrustedHost/host_key
  - path: /etc/ssh/trusted-host-key
    permissions: "0400"
    # permissions: "0640"
    content: |
      -----BEGIN OPENSSH PRIVATE KEY-----
      b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
      QyNTUxOQAAACBsxnlVrngsI+ZCJi5XLyR18GCLv2MGe8yjEwXrQch4ZwAAAJDIR7RxyEe0
      cQAAAAtzc2gtZWQyNTUxOQAAACBsxnlVrngsI+ZCJi5XLyR18GCLv2MGe8yjEwXrQch4Zw
      AAAEAYJGAVKeCNn9Yqs+6Wj23JQb5ODhvHwkgCaDagXeThIGzGeVWueCwj5kImLlcvJHXw
      YIu/YwZ7zKMTBetByHhnAAAAB3Jvb3QtY2EBAgMEBQY=
      -----END OPENSSH PRIVATE KEY-----

  - path: /etc/ssh/sshd_config.d/00-vault-config.conf
    content: |
      # AuthorizedPrincipalsFile /etc/ssh/auth_principals/%u

      # For client keys
      CASignatureAlgorithms ^ssh-rsa
      TrustedUserCAKeys /etc/ssh/trusted-user-ca-keys.pem

      # For host keys
      HostKey /etc/ssh/trusted-host-key
      HostCertificate /etc/ssh/trusted-host-rsa-cert.pub

runcmd:
  - systemctl reload sshd
